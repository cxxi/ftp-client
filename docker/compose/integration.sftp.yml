services:

  sftp:
    image: atmoz/sftp:latest
    ports:
      - "2222:22"
    command: "test:test:1001:1001:upload"
    volumes:
      - sftp_upload:/home/test/upload
      - ssh_host_keys:/etc/ssh
      - integration_state:/state
      - sftp_user_home:/home/test

  fingerprint:
    image: alpine:3.20
    depends_on:
      - sftp
    volumes:
      - ssh_host_keys:/etc/ssh:ro
      - integration_state:/state
      - ../bin/sftp-fingerprint:/usr/local/bin/sftp-fingerprint:ro
    environment:
      FP_HASH: md5
    entrypoint: ["/bin/sh", "-lc", "sftp-fingerprint"]

  keygen:
    image: alpine:3.20
    volumes:
      - integration_state:/state
      - ../bin/sftp-test-key:/usr/local/bin/sftp-test-key:ro
    entrypoint: ["/bin/sh", "-lc", "sftp-test-key"]

  authorize_key:
    image: alpine:3.20
    depends_on:
      - sftp
      - keygen
      - init_upload_perms
    volumes:
      - integration_state:/state
      - sftp_upload:/home/test/upload
      - sftp_user_home:/home/test
      - ../bin/sftp-authorize-key:/usr/local/bin/sftp-authorize-key:ro
    environment:
      SFTP_USER: test
      SFTP_UID: 1001
      SFTP_GID: 1001
    entrypoint: ["/bin/sh", "-lc", "sftp-authorize-key"]

  init_upload_perms:
    image: alpine:3.20
    volumes:
      - sftp_upload:/upload
    entrypoint: ["/bin/sh", "-lc", "chown -R 1001:1001 /upload && chmod -R u+rwX,g+rwX /upload"]

  php:
    image: ftp-client-php-sftp
    build:
      context: ../..
      dockerfile: docker/Dockerfile.integration.sftp
    working_dir: /app
    volumes:
      - ../..:/app
      - integration_state:/state
    depends_on:
      - fingerprint
      - authorize_key
      - init_upload_perms
    environment:
      SFTP_HOST: sftp
      SFTP_PORT: 22
      SFTP_USER: test
      SFTP_PASS: test
    command: ["bash", "-lc", "docker/bin/integration"]

volumes:
  integration_state:
  ssh_host_keys:
  sftp_user_home:
  sftp_upload: