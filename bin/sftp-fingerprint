#!/usr/bin/env sh
set -eu

# Fingerprint hash algorithm for ssh-keygen output.
# ext-ssh2 supports MD5 and SHA1 via ssh2_fingerprint().
# Default: md5
FP_HASH="${FP_HASH:-md5}"

case "${FP_HASH}" in
  md5|sha1)
    ;;
  *)
    echo "Invalid FP_HASH=${FP_HASH}. Allowed: md5, sha1" >&2
    exit 2
    ;;
esac

# Wait until at least one host pubkey exists (up to 20s)
i=0
while [ $i -lt 200 ]; do
  if [ -f /etc/ssh/ssh_host_ed25519_key.pub ] || [ -f /etc/ssh/ssh_host_rsa_key.pub ] || [ -f /etc/ssh/ssh_host_ecdsa_key.pub ]; then
    break
  fi
  i=$((i+1))
  sleep 0.1
done

# Ensure ssh-keygen is available (alpine)
if ! command -v ssh-keygen >/dev/null 2>&1; then
  apk add --no-cache openssh-keygen >/dev/null
fi

for f in /etc/ssh/ssh_host_ed25519_key.pub /etc/ssh/ssh_host_rsa_key.pub /etc/ssh/ssh_host_ecdsa_key.pub; do
  if [ -f "$f" ]; then
    algo="$(awk '{print $1}' "$f")"

    # ssh-keygen -lf outputs:
    # - md5: "MD5:aa:bb:cc:..."
    # - sha1: "SHA1:...." (format depends on OpenSSH version, but we keep it prefixed)
    fp="$(ssh-keygen -lf "$f" -E "${FP_HASH}" | awk '{print $2}')"

    # Ensure the prefix exists (defensive; should already be present)
    upper="$(printf '%s' "${FP_HASH}" | tr '[:lower:]' '[:upper:]')"
    case "${fp}" in
      ${upper}:*)
        ;;
      *)
        fp="${upper}:${fp}"
        ;;
    esac

    {
      echo "SFTP_HOSTKEY_ALGO=$algo"
      echo "SFTP_FINGERPRINT=$fp"
    } > /state/sftp.env

    echo "Wrote /state/sftp.env: $algo $fp"
    exit 0
  fi
done

echo "No ssh_host_*_key.pub found in /etc/ssh" >&2
ls -la /etc/ssh >&2 || true
exit 1
