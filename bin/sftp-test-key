#!/usr/bin/env sh
set -eu

# Where we store ephemeral test keys (shared with php container)
mkdir -p /state/keys

# Ensure ssh-keygen exists (alpine)
if ! command -v ssh-keygen >/dev/null 2>&1; then
  apk add --no-cache openssh-keygen >/dev/null
fi

# Generate (idempotent for the run)
if [ ! -s /state/keys/id_ed25519 ] || [ ! -s /state/keys/id_ed25519.pub ]; then
  ssh-keygen -t ed25519 -N "" -f /state/keys/id_ed25519 >/dev/null
fi

chmod 600 /state/keys/id_ed25519
chmod 644 /state/keys/id_ed25519.pub

echo "Generated /state/keys/id_ed25519 (+ .pub)"
